name: mkdocs to GitHub Pages

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Install mkdocs deps + build tool
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements.txt
          pip install build

      - name: Build wheel and place into docs/extra/
        shell: bash
        run: |
          python -m build --wheel

          wheel="$(ls -1 dist/*.whl | head -n 1)"
          fname="$(basename "$wheel" .whl)"
          parts=(${fname//-/ })

          if [ "${#parts[@]}" -eq 5 ]; then
            distname="${parts[0]}"
            pytag="${parts[2]}"
            abit="${parts[3]}"
            plat="${parts[4]}"
            stable="${distname}-0.0.0-${pytag}-${abit}-${plat}.whl"
          else
            distname="${parts[0]}"
            buildtag="${parts[2]}"
            pytag="${parts[3]}"
            abit="${parts[4]}"
            plat="${parts[5]}"
            stable="${distname}-0.0.0-${buildtag}-${pytag}-${abit}-${plat}.whl"
          fi

          cp -f "$wheel" "docs/extra/$stable"
          echo "Wrote docs/extra/$stable"

      - name: Download image processing tools
        run: |
          sudo apt update
          sudo apt-get -y install pngquant
          sudo apt-get -y install libcairo2-dev libfreetype6-dev libffi-dev libjpeg-dev libpng-dev libz-dev
          pip install "mkdocs-material[imaging]"

      - name: Deploy with MkDocs
        run: mkdocs gh-deploy --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
